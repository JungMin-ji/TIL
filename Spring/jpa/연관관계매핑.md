# 양방향 매핑

## @ManyToOne

현 클래스 중심으로 다대일 관계

### @JoinColumn(name="xxx")

테이블에서의 FK 지정

💡**테이블의 컬럼명**으로 지정 

## @OneToMany

현 클래스 중심으로 일대다 관계

### @OneToMany(mappedBy = "xxx")

@OneToMany(mappedBy = "team")

Player에서의 team 변수가 관리한다.

💡@ManyToOne에서의 FK로 걸려있는 **변수명**으로 지정

## mappedBy에 대해서

테이블은 FK만 존재하면 두 테이블은 양방향으로 접근가능하다.

(앞에서 테이블에게는 방향 개념이 없다고 설명했지만, 굳이 방향성을 부여하자면, FK로 두 테이블이 join되면 모두 접근 가능하므로 양방향이 있다고 설명한 것!)

하지만, 객체는 각 클래스의 필드에 참조를 해야지만 접근가능하다. 

Player → Team   Player 클래스에 Team 타입의 변수를 넣음   << *Team team*>>

Team → Player   Team 클래스에 Player 타입의 변수(주로 리스트)를 넣음  <<*List<Player> players*>>

이렇게 해야 양방향 연관관계가 생성된다. 

⇒ 여기서 Player 클래스의 team을 PLAYER 테이블의 team_id로 매핑할 것인지 

Team 클래스의 players를 PLAYER 테이블의 team_id로 매핑할 것인지 정해줘야 함!

*예를 들어, 만일 내가 다른 팀으로 바꾸고 싶을 때
Player의 team값을 바꿔야 할 지, Team의 members의 값을 바꿔야 할 지??
DB에서는 FK값만 업데이트되면 된다. → 둘 중 하나로 FK를 관리해야 함*
⇒ 즉, 테이블을 관리할 주인을 정해야 함

## 연관관계 주인 정하기

연관관계의 주인만이 FK를 등록, 수정할 수 있다.

주인이 아닌 쪽은 조회만 가능하다.

주인인 쪽은 @JoinColumn(name="xxx") 으로 FK와 매핑하고,

주인이 아닌 쪽은 @JoinColumn(name="xxx") 으로 주인을 지정한다.

### 누구를 주인으로 정할까?

테이블에서 FK가 있는 곳을 주인으로 정하기!

## 연관관계 시 메서드

- 연관관계 편의 메서드

player, team을 생성하고 player에 맞은 **team을 설정**해주고, team에서 player를 조회하기 위해 **리스트에 player를 저장**한다.

```jsx
Team team = new Team();
team.setName("TeamA");
em.persist(team);

Player player = new Player();
player.setName("p1");

team.getMembers().add(player); // team쪽에 player 집어넣음 

member.setTeam(team); // member쪽에 team 설정함

em.persist(member);
```

⇒ 연관관계 편의 메서드를 생성하자.

```jsx
public class Player{
...
public void changeTeam(Team team){
	this.team = team;
	// 위 코드에서 team.getMembers().add(player) 지우고 여기에 넣음
	team.getPlayers().add(this);  
	}
}
```

⇒ main에서 changeTeam 메서드만 호출하면 team쪽에도 player가 추가 됨.

> 💡 setter에 다른 로직이 들어가면, setXXX메서드명 대신 다른 메서드명을 사용한다.

- 무한 루프 조심!

ex) toString(), lombok, JSON 생성 라이브러리

toString() - Member 클래스에서 toString 호출하면 Team 클래스에서 toString을 호출한다.
Team클래스의 toString을 호출하면 또 Member의 toString을 호출하기 때문에
무한 반복!!
