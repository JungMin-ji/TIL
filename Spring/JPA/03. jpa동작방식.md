## JPA가 내부적으로 어떻게 동작하는가

JPA의 내부 동작 방식 알고 개발하는 것과 모르고 개발하는 것은 차이가 있다!

EntityManagerFactory가 고객의 요청이 들어오면, EntityManager를 생성한다. EntityManager를 통해 영속성 컨텍스트에 접근한다. 

### 영속성 컨텍스트?

엔티티를 영구적으로 저장하는 환경이다.

앞에서 배운 1차 캐시도 영속성 컨텍스트 내부에 존재한다. 

### 엔티티의 생명주기

- 비영속 : persist() 하기 전
- 영속 : persist() 함 → 영속성 컨텍스트에 저장됨
- 준영속 : detach() 해서 영속성 컨텍스트에서 분리함
- 삭제 : remove() 해서 객체 삭제함

### 쓰기 지연

persist() 하면 쓰기 **지연 SQL 저장소에 SQL**이 쌓인다. commit()하면 한 번에 DB로 날라감. → **flush()**

쓰기 지연 SQL 저장소도 영속성 컨텍스트 내부에 존재한다.

### 엔티티 수정

엔티티를 수정하면 변경을 감지(dirty checking)해서 자동으로 업데이트 해준다. 

자바의 collection을 생각해보자. collection에 여러 객체다 담겨있을 때, 객체의 프로퍼티를 set메서드로 바꾸면 collection을 업데이트하지 않아도 collection에서 해당 객체의 프로퍼티가 바뀌어있다. 

**이처럼 jpa에서도 엔티티를 수정하면 다시 persist하지 않아도 된다.**

변경은 어떻게 감지?    
1차 캐시에서 값을 읽어온 상태를 캡쳐한 스냅샷과 엔티티를 비교해서 변경을 감지한다.

### flush

- 영속성 컨텍스트의 변경 내용을 DB에 반영한다.
- 쌓여있는 쓰기 지연 SQL 저장소의 쿼리를 DB에 전송한다.
